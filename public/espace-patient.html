<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Espace Patient | ALLO KINÃ‰</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        body { background-color: var(--bg-color); color: var(--text-color); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 5%; background: var(--nav-bg); border-bottom: 2px solid var(--gold-accent); }
        .dashboard-container { padding: 3rem 5%; min-height: 80vh; max-width: 1000px; margin: 0 auto; }
        .welcome-card { background: var(--card-bg); padding: 2rem; border-radius: 10px; box-shadow: var(--shadow-premium); border-left: 5px solid var(--gold-accent); margin-bottom: 2rem; }
        .action-btn { background: var(--gold-accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; margin-top: 15px; transition: 0.3s; }
        .action-btn:hover { background: #b5952f; }
        .logout-btn { background: #ff4757; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .logout-btn:hover { background: #ff6b81; }
        .history-box { background: var(--card-bg); padding: 2rem; border-radius: 10px; text-align: center; border: 1px dashed var(--gold-accent); opacity: 0.8; }
    </style>
</head>
<body>

   <header>
        <a href="index.html" class="logo-link">
            <img src="logo.png" alt="Logo Allo KinÃ©" style="width: 55px; height: 55px; border-radius: 50%; border: 2px solid var(--gold-accent); object-fit: cover;">
            <div style="display: flex; flex-direction: column; justify-content: center;">
                <div class="brand-name" style="line-height: 1;">ALLO KINÃ‰</div>
                <div style="color: var(--gold-accent); font-size: 0.85rem; font-weight: bold; letter-spacing: 1.5px; margin-top: 4px; text-transform: uppercase;">
                    Mon Espace Patient
                </div>
            </div>
        </a>
        
        <div class="menu-toggle" id="mobile-menu">â˜°</div>
        <nav>
            <ul id="nav-menu">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="competences.html">Soins & Tarifs</a></li>
                <li><a href="experiences.html">Expertise</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li id="nav-logout"><a href="#" id="logout-btn-nav" style="color: #ff4757; font-weight: bold;">DÃ©connexion</a></li>
                <li><button id="theme-toggle" class="theme-btn">ðŸŒ™</button></li>
            </ul>
        </nav>
    </header>

    <main class="dashboard-container">
        <div class="welcome-card">
            <h2>Bienvenue dans votre espace personnel de santÃ©</h2>
            <p style="margin-top: 10px; opacity: 0.9;">GÃ©rez vos consultations, suivez votre rÃ©Ã©ducation et contactez le cabinet du Dr Ghraybia en toute simplicitÃ©.</p>
            <a href="contact.html" class="action-btn">Prendre un nouveau rendez-vous</a>
        </div>

        <h3 style="margin-bottom: 1rem; color: var(--gold-accent);">Historique de mes soins</h3>
        
        <div class="history-box">
            <p>ðŸ“‹ Vos futurs rendez-vous et bilans s'afficheront ici.</p>
            <p style="font-size: 0.85rem; margin-top: 10px; opacity: 0.7;">(FonctionnalitÃ© en cours de synchronisation avec le cabinet)</p>
        </div>
    </main>

    <script>
        // --- VÃ‰RIFIER L'AUTHENTIFICATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/auth/verify', {
                    credentials: 'include'
                });
                
                if (!response.ok || (await response.clone().json()).role !== 'patient') {
                    window.location.href = 'login.html';
                    return;
                }
            } catch (err) {
                window.location.href = 'login.html';
                return;
            }

            // --- DÃ‰CONNEXION ---
            document.getElementById('logout-btn-nav').addEventListener('click', async (e) => {
                e.preventDefault();
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = 'index.html';
            });

        // --- CHARGER L'HISTORIQUE DES RDV ---
        const loadMyHistory = async () => {
            try {
                const response = await fetch('/api/appointments', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (response.ok) {
                    const appointments = await response.json();
                    const historyBox = document.querySelector('.history-box');
                    
                    if (appointments.length === 0) {
                        historyBox.innerHTML = '<p>ðŸ“‹ Vous n\'avez pas encore de rendez-vous ou de bilans enregistrÃ©s.</p>';
                    } else {
                        let htmlContent = '<h4 style="color:var(--gold-accent); margin-bottom:15px; text-align:left;">Vos derniÃ¨res demandes :</h4><ul style="list-style:none; padding:0; text-align:left;">';
                        
                        appointments.forEach(app => {
                            const dateStr = new Date(app.createdAt).toLocaleDateString('fr-FR');
                            let statusColor = app.statut === 'en_attente' ? 'orange' : 'green';
                            
                            htmlContent += `
                                <li style="background: rgba(255,255,255,0.05); margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                    <strong>${dateStr}</strong> - ${app.motif} <br>
                                    <span style="font-size:0.85rem; opacity:0.8;">Diagnostic : ${app.diagnostic || 'En attente'}</span><br>
                                    <span style="font-size:0.85rem; color:${statusColor}; font-weight:bold;">Statut: ${app.statut.replace('_', ' ')}</span>
                                </li>
                            `;
                        });
                        htmlContent += '</ul>';
                        historyBox.innerHTML = htmlContent;
                    }
                } else if (response.status === 401) {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error("Erreur de chargement de l'historique", error);
                document.querySelector('.history-box').innerHTML = '<p style="color:#ff4757;">Erreur de chargement des donnÃ©es.</p>';
            }
        };

        // Lancer le chargement au dÃ©marrage de la page
        loadMyHistory();
    </script>
</body>
</html>