<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Espace Patient | ALLO KIN√â</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        body { background-color: var(--bg-color); color: var(--text-color); }
        .dashboard-container { padding: 140px 5% 50px; min-height: 80vh; max-width: 1200px; margin: 0 auto; }
        .welcome-card { 
            background: var(--card-bg); 
            padding: 2.5rem; 
            border-radius: 15px; 
            box-shadow: var(--shadow-premium); 
            border-left: 5px solid var(--gold-accent); 
            margin-bottom: 3rem; 
        }
        .action-btn { 
            background: var(--gradient-gold); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-weight: bold; 
            text-decoration: none; 
            display: inline-block; 
            margin-top: 20px; 
            transition: var(--transition); 
            box-shadow: 0 4px 15px rgba(197, 160, 89, 0.2);
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(197, 160, 89, 0.4); }
        .history-box { 
            background: var(--card-bg); 
            padding: 2.5rem; 
            border-radius: 15px; 
            text-align: center; 
            border: 1px dashed var(--gold-accent); 
            box-shadow: var(--shadow-premium);
        }
        .appointment-item {
            background: rgba(197, 160, 89, 0.05);
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--gold-accent);
            text-align: left;
            transition: var(--transition);
        }
        .appointment-item:hover { transform: scale(1.01); background: rgba(197, 160, 89, 0.1); }
    </style>
</head>
<body>

    <header class="pro-header">
        <a href="/" class="logo-link">
            <img src="/logo.png" alt="Logo Allo Kin√©" style="width: 55px; height: 55px; border-radius: 50%; border: 2px solid var(--gold-accent); object-fit: cover;">
            <div style="display: flex; flex-direction: column; justify-content: center;">
                <div class="brand-name" style="line-height: 1;">ALLO KIN√â</div>
                <div style="color: var(--gold-accent); font-size: 0.85rem; font-weight: bold; letter-spacing: 1.5px; margin-top: 4px; text-transform: uppercase;">
                    Espace Patient
                </div>
            </div>
        </a>
        
        <div class="menu-toggle" id="mobile-menu">‚ò∞</div>
        <nav>
            <ul id="nav-list">
                <li><a href="/">Accueil</a></li>
                <li><a href="/cabinet.html">Le Cabinet</a></li>
                <li><a href="/blog.html">Actualit√©s</a></li>
                <li><a href="/contact.html">Prendre RDV</a></li>
                <li id="auth-nav-item"></li>
                <li><button id="theme-toggle" class="theme-btn">üåô</button></li>
            </ul>
        </nav>
    </header>

    <main class="dashboard-container">
        <div class="welcome-card reveal active">
            <h2 style="font-family: 'Georgia', serif; color: var(--nav-bg);">Bienvenue dans votre espace sant√©</h2>
            <p style="margin-top: 15px; font-size: 1.1rem; opacity: 0.8;">Suivez vos soins, acc√©dez √† vos bilans et programmez vos prochaines s√©ances en toute s√©r√©nit√©.</p>
            <a href="/contact.html" class="action-btn">Nouveau rendez-vous</a>
        </div>

        <h3 style="margin-bottom: 1.5rem; color: var(--gold-accent); font-family: 'Georgia', serif; font-size: 1.8rem;">Historique de vos s√©ances</h3>
        
        <div id="patient-history" class="history-box">
            <p>Chargement de vos informations s√©curis√©es...</p>
        </div>
    </main>

    <footer class="pro-footer">
        <div class="footer-container">
            <div class="footer-col">
                <h3 class="brand-name">ALLO KIN√â</h3>
                <p>Votre plateforme de suivi th√©rapeutique personnalis√©e. La confidentialit√© de vos donn√©es est notre priorit√©.</p>
            </div>
            <div class="footer-col">
                <h3>Liens Utiles</h3>
                <ul>
                    <li><a href="/cabinet.html">Le Cabinet</a></li>
                    <li><a href="/blog.html">Conseils Sant√©</a></li>
                    <li><a href="/faq.html">Assistance FAQ</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h3>Support</h3>
                <p>üìç Grenoble, France</p>
                <p>üìû 04 76 00 00 00</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Espace Patient Allo Kin√©. Tous droits r√©serv√©s.</p>
        </div>
    </footer>

    <script src="/script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. V√âRIFIER L'ACC√àS PATIENT
            try {
                const response = await fetch('/api/auth/verify', { credentials: 'include' });
                const data = await response.json();
                
                if (!response.ok || data.role !== 'patient') {
                    window.location.href = '/login.html';
                    return;
                }
            } catch (err) {
                window.location.href = '/login.html';
                return;
            }

            // 2. CHARGER L'HISTORIQUE
            const historyBox = document.getElementById('patient-history');
            
            try {
                const res = await fetch('/api/appointments', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (res.ok) {
                    const appointments = await res.json();
                    
                    if (!appointments || appointments.length === 0) {
                        historyBox.innerHTML = '<p>üìã Vous n\'avez pas encore de rendez-vous enregistr√©.</p>';
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        appointments.forEach(app => {
                            const date = new Date(app.createdAt).toLocaleDateString('fr-FR');
                            const statusLabel = app.statut === 'en_attente' ? '‚è≥ En attente' : '‚úÖ Valid√©';
                            const color = app.statut === 'en_attente' ? '#f39c12' : '#27ae60';
                            
                            html += `
                                <div class="appointment-item">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <strong>${date} - ${app.motif}</strong>
                                        <span style="color:${color}; font-weight:bold; font-size:0.85rem;">${statusLabel}</span>
                                    </div>
                                    <p style="margin-top:8px; font-size:0.9rem; opacity:0.8;">Note du praticien : ${app.diagnostic || 'Dossier en cours d\\'analyse'}</p>
                                </div>
                            `;
                        });
                        html += '</div>';
                        historyBox.innerHTML = html;
                    }
                }
            } catch (error) {
                historyBox.innerHTML = '<p style="color:#ff4757;">Impossible de charger l\'historique.</p>';
            }
        });
    </script>
</body>
</html>