<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Espace Patient | ALLO KIN√â</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        body { background-color: var(--bg-color); color: var(--text-color); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 5%; background: var(--nav-bg); border-bottom: 2px solid var(--gold-accent); }
        .dashboard-container { padding: 3rem 5%; min-height: 80vh; max-width: 1000px; margin: 0 auto; }
        .welcome-card { background: var(--card-bg); padding: 2rem; border-radius: 10px; box-shadow: var(--shadow-premium); border-left: 5px solid var(--gold-accent); margin-bottom: 2rem; }
        .action-btn { background: var(--gold-accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; margin-top: 15px; transition: 0.3s; }
        .action-btn:hover { background: #b5952f; }
        .logout-btn { background: #ff4757; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .logout-btn:hover { background: #ff6b81; }
        .history-box { background: var(--card-bg); padding: 2rem; border-radius: 10px; text-align: center; border: 1px dashed var(--gold-accent); opacity: 0.8; }
    </style>
</head>
<body>

   <header class="pro-header">
        <a href="index.html" class="logo-link">
            <img src="logo.png" alt="Logo Allo Kin√©" style="width: 55px; height: 55px; border-radius: 50%; border: 2px solid var(--gold-accent); object-fit: cover;">
            <div style="display: flex; flex-direction: column; justify-content: center;">
                <div class="brand-name" style="line-height: 1;">ALLO KIN√â</div>
                <div style="color: var(--gold-accent); font-size: 0.85rem; font-weight: bold; letter-spacing: 1.5px; margin-top: 4px; text-transform: uppercase;">
                    Mon Espace Patient
                </div>
            </div>
        </a>
        
        <div class="menu-toggle" id="mobile-menu">‚ò∞</div>
        <nav>
            <ul id="nav-menu">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="cabinet.html">Le Cabinet</a></li>
                <li><a href="competences.html">Soins & Tarifs</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li id="nav-logout"><a href="#" id="logout-btn-nav" style="color: #ff4757; font-weight: bold;">D√©connexion</a></li>
                <li><button id="theme-toggle" class="theme-btn">üåô</button></li>
            </ul>
        </nav>
    </header>

    <main class="dashboard-container">
        <div class="welcome-card">
            <h2>Bienvenue dans votre espace personnel de sant√©</h2>
            <p style="margin-top: 10px; opacity: 0.9;">G√©rez vos consultations, suivez votre r√©√©ducation et contactez le cabinet du Dr Ghraybia en toute simplicit√©.</p>
            <a href="contact.html" class="action-btn">Prendre un nouveau rendez-vous</a>
        </div>

        <h3 style="margin-bottom: 1rem; color: var(--gold-accent);">Historique de mes soins</h3>
        
        <div class="history-box">
            <p>üìã Vos futurs rendez-vous et bilans s'afficheront ici.</p>
            <p style="font-size: 0.85rem; margin-top: 10px; opacity: 0.7;">(Fonctionnalit√© en cours de synchronisation avec le cabinet)</p>
        </div>
    </main>

    <footer class="pro-footer">
        <div class="footer-container">
            <div class="footer-col">
                <h3 class="brand-name">ALLO KIN√â</h3>
                <p>L'excellence de la r√©√©ducation √† votre service. Des soins personnalis√©s pour retrouver votre pleine mobilit√©.</p>
            </div>
            <div class="footer-col">
                <h3>Liens Rapides</h3>
                <ul>
                    <li><a href="/cabinet.html">D√©couvrir le Cabinet</a></li>
                    <li><a href="/experiences.html">Nos Exp√©riences</a></li>
                    <li><a href="/blog.html">Blog & Actualit√©s</a></li>
                    <li><a href="/faq.html">Foire Aux Questions</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h3>Contact & Infos</h3>
                <p>üìç 123 Avenue de la Sant√©, Grenoble</p>
                <p>üìû 04 76 00 00 00</p>
                <p>‚úâÔ∏è contact@allokine.fr</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Allo Kin√©. Con√ßu par Omar Ghraybia.</p>
        </div>
    </footer>

    <script>
        // --- V√âRIFIER L'AUTHENTIFICATION ET CHARGER LA PAGE ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/auth/verify', {
                    credentials: 'include'
                });
                
                if (!response.ok || (await response.clone().json()).role !== 'patient') {
                    window.location.href = 'login.html';
                    return; // Stoppe l'ex√©cution si non connect√©
                }
            } catch (err) {
                window.location.href = 'login.html';
                return;
            }

            // --- D√âCONNEXION ---
            const logoutBtn = document.getElementById('logout-btn-nav');
            if(logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    // Nettoyage complet
                    localStorage.removeItem('token');
                    localStorage.removeItem('role');
                    await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
                    window.location.href = 'index.html';
                });
            }

            // --- CHARGER L'HISTORIQUE DES RDV ---
            const loadMyHistory = async () => {
                try {
                    const response = await fetch('/api/appointments', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const appointments = await response.json();
                        const historyBox = document.querySelector('.history-box');
                        
                        if (appointments.length === 0) {
                            historyBox.innerHTML = '<p>üìã Vous n\'avez pas encore de rendez-vous ou de bilans enregistr√©s.</p>';
                        } else {
                            let htmlContent = '<h4 style="color:var(--gold-accent); margin-bottom:15px; text-align:left;">Vos derni√®res demandes :</h4><ul style="list-style:none; padding:0; text-align:left;">';
                            
                            appointments.forEach(app => {
                                const dateStr = new Date(app.createdAt).toLocaleDateString('fr-FR');
                                let statusColor = app.statut === 'en_attente' ? 'orange' : 'green';
                                
                                htmlContent += `
                                    <li style="background: rgba(255,255,255,0.05); margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                        <strong>${dateStr}</strong> - ${app.motif} <br>
                                        <span style="font-size:0.85rem; opacity:0.8;">Diagnostic : ${app.diagnostic || 'En attente'}</span><br>
                                        <span style="font-size:0.85rem; color:${statusColor}; font-weight:bold;">Statut: ${app.statut.replace('_', ' ')}</span>
                                    </li>
                                `;
                            });
                            htmlContent += '</ul>';
                            historyBox.innerHTML = htmlContent;
                        }
                    } else if (response.status === 401) {
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error("Erreur de chargement de l'historique", error);
                    document.querySelector('.history-box').innerHTML = '<p style="color:#ff4757;">Erreur de chargement des donn√©es.</p>';
                }
            };

            // Lancer le chargement
            loadMyHistory();

        }); // <--- C'EST CETTE LIGNE QUI MANQUAIT ! Elle ferme le bloc DOMContentLoaded
    </script>
</body>
</html>